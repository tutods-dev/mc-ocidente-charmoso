import{getRequestEvent as g,isServer as s}from"solid-js/web";import{provideRequestEvent as b}from"solid-js/web/storage";import{d as A}from"./fetchEvent.mjs";import{createSignal as P,getOwner as D,getListener as L,onCleanup as M,startTransition as E,sharedConfig as h}from"solid-js";import{r as F,e as U,t as j}from"./routing.mjs";function W(e,r,n){if(typeof e!="function")throw new Error("Export from a 'use server' module must be a function");const a="";return new Proxy(e,{get(c,i,p){return i==="url"?`${a}/_server?id=${encodeURIComponent(r)}&name=${encodeURIComponent(n)}`:i==="GET"?p:c[i]},apply(c,i,p){const v=g();if(!v)throw new Error("Cannot call server function outside of a request");const w=A(v);return w.locals.serverFunctionMeta={id:r+"#"+n},w.serverOnly=!0,b(w,()=>e.apply(i,p))}})}const q="Location",H=5e3,S=18e4;let m=new Map;s||setInterval(()=>{const e=Date.now();for(let[r,n]of m.entries())!n[3].count&&e-n[0]>S&&m.delete(r)},3e5);function C(){if(!s)return m;const e=g();if(!e)throw new Error("Cannot find cache context");return(e.router||(e.router={})).cache||(e.router.cache=new Map)}function J(e,r=!0){return E(()=>{const n=Date.now();_(e,a=>{r&&(a[0]=0),a[3][1](n)})})}function _(e,r){e&&!Array.isArray(e)&&(e=[e]);for(let n of m.keys())(e===void 0||G(n,e))&&r(m.get(n))}function T(e,r){e.GET&&(e=e.GET);const n=(...a)=>{const c=C(),i=U(),p=j(),w=D()?F():void 0,O=Date.now(),l=r+I(a);let t=c.get(l),x;if(s){const o=g();if(o){const f=(o.router||(o.router={})).dataOnly;if(f){const d=o&&(o.router.data||(o.router.data={}));if(d&&l in d)return d[l];if(Array.isArray(f)&&!f.includes(l))return d[l]=void 0,Promise.resolve()}}}if(L()&&!s&&(x=!0,M(()=>t[3].count--)),t&&t[0]&&(s||i==="native"||t[3].count||Date.now()-t[0]<H)){x&&(t[3].count++,t[3][0]()),t[2]==="preload"&&i!=="preload"&&(t[0]=O);let o=t[1];return i!=="preload"&&(o="then"in t[1]?t[1].then(y(!1),y(!0)):y(!1)(t[1]),!s&&i==="navigate"&&E(()=>t[3][1](t[0]))),p&&"then"in o&&o.catch(()=>{}),o}let u=!s&&h.context&&h.has(l)?h.load(l):e(...a);if(t?(t[0]=O,t[1]=u,t[2]=i,!s&&i==="navigate"&&E(()=>t[3][1](t[0]))):(c.set(l,t=[O,u,i,P(O)]),t[3].count=0),x&&(t[3].count++,t[3][0]()),s){const o=g();if(o&&o.router.dataOnly)return o.router.data[l]=u}if(i!=="preload"&&(u="then"in u?u.then(y(!1),y(!0)):y(!1)(u)),p&&"then"in u&&u.catch(()=>{}),s&&h.context&&h.context.async&&!h.context.noHydrate){const o=g();(!o||!o.serverOnly)&&h.context.serialize(l,u)}return u;function y(o){return async f=>{if(f instanceof Response){const d=f.headers.get(q);if(d!==null){if(w&&d.startsWith("/"))E(()=>{w(d,{replace:!0})});else if(!s)window.location.href=d;else if(s){const R=g();R&&(R.response={status:302,headers:new Headers({Location:d})})}return}f.customBody&&(f=await f.customBody())}if(o)throw f;return f}}};return n.keyFor=(...a)=>r+I(a),n.key=r,n}T.set=(e,r)=>{const n=C(),a=Date.now();let c=n.get(e);c?(c[0]=a,c[1]=r,c[2]="preload"):(n.set(e,c=[a,r,,P(a)]),c[3].count=0)};T.clear=()=>C().clear();function G(e,r){for(let n of r)if(e.startsWith(n))return!0;return!1}function I(e){return JSON.stringify(e,(r,n)=>K(n)?Object.keys(n).sort().reduce((a,c)=>(a[c]=n[c],a),{}):n)}function K(e){let r;return e!=null&&typeof e=="object"&&(!(r=Object.getPrototypeOf(e))||r===Object.prototype)}const V={sanity:{projectId:"sg9zb269",dataset:"production",apiVersion:"X"},isProduction:!1};export{_ as a,T as b,W as c,V as e,I as h,J as r};
